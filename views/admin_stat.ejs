<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>History</title>
  <!-- <link rel="stylesheet" href="./dist/output.css" /> -->
   <script src="https://cdn.tailwindcss.com"></script>
  <!-- font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tangerine:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Kapakana:wght@300..400&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Libre+Caslon+Display&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap"
    rel="stylesheet">
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">

  <!-- font -->
  <!-- manu -->
  <script src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons.js"></script>
  <!-- arrow -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
</head>

<body class="bg-gray-50 min-h-screen m-0">
  <%- include('nav_main_admin', { activeTop: 'stat' , activePage: 'admin_stat' }) %>

  <!-- Main Content -->
  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6">
    <!-- Page Header -->
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-gray-900">สถิติและรายงาน</h1>
      <p class="text-sm text-gray-600 mt-1">ภาพรวมรายได้และประสิทธิภาพการทำงาน</p>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5">
        <p class="text-sm font-medium text-gray-600 mb-3">จำนวนผู้ใช้บริการวันนี้</p>
        <p class="text-2xl font-bold text-[#A5848F]"><%= todayCustomers %> คน</p>
      </div>
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5">
        <p class="text-sm font-medium text-gray-600 mb-3">รายได้วันนี้</p>
        <p class="text-2xl font-bold text-[#A5848F]"><%= todayRevenue.toLocaleString() %> บาท</p>
      </div>
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5">
        <p class="text-sm font-medium text-gray-600 mb-3">รายได้เดือนนี้</p>
        <p class="text-2xl font-bold text-[#A5848F]"><%= monthRevenue.toLocaleString() %> บาท</p>
      </div>
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5">
        <p class="text-sm font-medium text-gray-600 mb-3">กำไรสุทธิเดือนนี้</p>
        <p class="text-2xl font-bold text-[#A5848F]"><%= netProfit.toLocaleString() %> บาท</p>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">รายได้รายวัน (7 วันล่าสุด)</h3>
        <div id="bar-chart"></div>
      </div>
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">รายได้รายเดือน (9 เดือนล่าสุด)</h3>
        <div id="area-chart"></div>
      </div>
    </div>

    <!-- Bottom Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">การวิเคราะห์กำไร (6 เดือนล่าสุด)</h3>
        <div id="bar-chart2"></div>
      </div>
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">สินค้าใกล้หมด/หมดสต็อก</h3>
        <div class="overflow-x-auto">
          <table class="w-full border-collapse text-base">
            <thead class="bg-gray-50">
              <tr>
                <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-900">ลำดับ</th>
                <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-900">ชื่อสินค้า</th>
                <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-900">สถานะ</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <% if (lowStockProducts && lowStockProducts.length > 0) { %>
                <% lowStockProducts.forEach((product, index) => { %>
              <tr class="hover:bg-gray-50">
                <td class="border border-gray-200 px-4 py-3 text-gray-700"><%= index + 1 %></td>
                <td class="border border-gray-200 px-4 py-3 text-gray-900"><%= product.name %></td>
                <td class="border border-gray-200 px-4 py-3">
                  <% if (product.stock_qty === 0) { %>
                  <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                    หมดสต็อก (<%= product.stock_qty %>)
                  </span>
                  <% } else if (product.stock_qty < 5) { %>
                  <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                    น้อยมาก (<%= product.stock_qty %>)
                  </span>
                  <% } else { %>
                  <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                    ใกล้หมด (<%= product.stock_qty %>)
                  </span>
                  <% } %>
                </td>
              </tr>
                <% }); %>
              <% } else { %>
              <tr>
                <td colspan="3" class="border border-gray-200 px-4 py-3 text-center text-gray-500">
                  ไม่มีสินค้าที่ใกล้หมดหรือหมดสต็อก
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>



  <!-- apexchart -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/4.7.0/apexcharts.min.js"></script>

  <script>
    // Prepare data from server
    const dailyRevenue = <%- JSON.stringify(dailyRevenue) %>;
    const monthlyRevenue = <%- JSON.stringify(monthlyRevenue) %>;
    const monthlyProfit = <%- JSON.stringify(monthlyProfit) %>;

    // Thai month names
    const thaiMonths = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];

    //กราฟแท่ง - รายได้รายวัน (7 วันล่าสุด)
    const barChartOptions = {
      series: [
        {
          name: 'รายได้',
          data: dailyRevenue.map(d => d.revenue),
        },
      ],
      chart: {
        type: 'bar',
        height: 350,
        toolbar: {
          show: false,
        },
      },
      colors: ['#246dec'],
      plotOptions: {
        bar: {
          distributed: false,
          borderRadius: 4,
          horizontal: false,
          columnWidth: '50%',
        },
      },
      dataLabels: {
        enabled: false,
      },
      legend: {
        show: false,
      },
      xaxis: {
        categories: dailyRevenue.map(d => {
          const date = new Date(d.date);
          return `${date.getDate()}/${date.getMonth() + 1}`;
        }),
      },
      yaxis: {
        title: {
          text: 'รายได้ (฿)',
        },
      },
      tooltip: {
        y: {
          formatter: function (val) {
            return val.toLocaleString() + ' ฿';
          },
        },
      },
    };

    const barChart = new ApexCharts(
      document.querySelector('#bar-chart'),
      barChartOptions
    );
    barChart.render();



    //กราฟเส้น - รายได้รายเดือน (9 เดือนล่าสุด)
    const areaChartOptions = {
      series: [
        {
          name: 'รายได้',
          data: monthlyRevenue.map(m => m.revenue),
        },
      ],
      chart: {
        height: 350,
        type: 'area',
        toolbar: {
          show: false,
        },
      },
      colors: ['#38bdf8'],
      dataLabels: {
        enabled: false,
      },
      stroke: {
        curve: 'smooth',
      },
      labels: monthlyRevenue.map(m => thaiMonths[m.month - 1]),

      markers: {
        size: 0,
      },
      yaxis: [
        {
          title: {
            text: 'รายได้ (฿)',
          },
        },

      ],
      xaxis: {
        title: {
          text: '9 เดือนล่าสุด',
        },
      },

      tooltip: {
        shared: true,
        intersect: false,
        y: {
          formatter: function (val) {
            return val.toLocaleString() + ' ฿';
          },
        },
      },
    };

    const areaChart = new ApexCharts(
      document.querySelector('#area-chart'),
      areaChartOptions
    );
    areaChart.render();



    // กราฟแท่งกลุ่ม - การวิเคราะห์กำไร (6 เดือนล่าสุด)
    const barChartOptions2 = {
      series: [
        {
          name: 'รายได้ (฿)',
          data: monthlyProfit.map(m => m.revenue),
        },
        {
          name: 'ต้นทุน (฿)',
          data: monthlyProfit.map(m => m.cost),
        },
        {
          name: 'กำไรสุทธิ (฿)',
          data: monthlyProfit.map(m => m.profit),
        },
      ],
      chart: {
        type: 'bar',
        height: 400,
        width: 900,
        toolbar: {
          show: false,
        },
      },
      plotOptions: {
        bar: {
          horizontal: false,
          columnWidth: '50%',
          borderRadius: 6,
        },
      },
      colors: ['#4A90E2', '#E57373', '#81C784'], // น้ำเงิน แดง เขียว
      dataLabels: {
        enabled: false,
      },
      stroke: {
        show: true,
        width: 2,
        colors: ['transparent'],
      },
      xaxis: {
        categories: monthlyProfit.map(m => thaiMonths[m.month - 1]),
      },
      yaxis: {
        title: {
          text: 'จำนวนเงิน (฿)',
        },
      },
      fill: {
        opacity: 1,
      },
      tooltip: {
        y: {
          formatter: function (val) {
            return val.toLocaleString() + " ฿";
          },
        },
      },
      legend: {
        position: 'top',
        horizontalAlign: 'center',
      },
    };

    const barChart2 = new ApexCharts(
      document.querySelector('#bar-chart2'),
      barChartOptions2
    );
    barChart2.render();

  </script>
</body>

</html>