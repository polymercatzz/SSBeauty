<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>SSBeauty - admin ระบบจัดการชำระเงิน</title>
  <script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="bg-gray-50 min-h-screen m-0">
    <%- include('nav_main_admin', { activePage: 'payment', activeTop: 'home' }) %>
    
    <!-- Main Content -->
    <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6">
        <!-- Page Header -->
        <div class="mb-6 flex items-start justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">จัดการชำระเงิน</h1>
                <p class="text-sm text-gray-600 mt-1">จัดการและตรวจสอบการชำระเงินของลูกค้า</p>
            </div>
            <div>
                <button id="refreshBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded">รีเฟรช</button>
            </div>
        </div>

        <!-- Appointments & Receipt Panel -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Appointments List -->
            <div class="lg:col-span-1 space-y-3">
                <% appointments.forEach((a, index) => { %>
                    <div class="appointment-item cursor-pointer" onclick="openReceipt(<%= index %>)">
                        <div class="bg-white shadow-sm hover:shadow-md transition-shadow rounded-lg p-4 border border-gray-200 group">
                            <div class="space-y-3">
                                <div class="flex items-center gap-3">
                                    <% 
                                        const dayOfWeek = new Date(a.appointment_date).getDay();
                                        const dayColors = {
                                            0: 'bg-red-500',      // Sunday
                                            1: 'bg-yellow-500',   // Monday
                                            2: 'bg-pink-500',     // Tuesday
                                            3: 'bg-green-500',    // Wednesday
                                            4: 'bg-orange-500',   // Thursday
                                            5: 'bg-blue-500',     // Friday
                                            6: 'bg-purple-500'    // Saturday
                                        };
                                        const bgColor = dayColors[dayOfWeek] || 'bg-[#A5848F]';
                                    %>
                                    <div class="<%= bgColor %> text-white rounded-lg px-3 py-1.5 text-sm font-medium">
                                        <%= new Date(a.appointment_date).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' }) %>
                                    </div>
                                    <span class="text-gray-700 text-base font-medium">
                                        <%= new Date(a.appointment_date).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) %> น.
                                    </span>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex items-center gap-2">
                                        <label class="text-sm font-medium text-gray-700 min-w-[80px]">รายการ:</label>
                                        <input type="text" value="<%= a.Service ? a.Service.name : '' %>" 
                                            class="flex-1 border border-gray-300 rounded-lg px-3 py-1.5 text-base bg-gray-50" readonly>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <label class="text-sm font-medium text-gray-700 min-w-[80px]">ลูกค้า:</label>
                                        <input type="text" value="<%= a.User ? a.User.first_name + ' ' + a.User.last_name : '' %>" 
                                            class="flex-1 border border-gray-300 rounded-lg px-3 py-1.5 text-base bg-gray-50" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>

            <!-- Receipt Panel -->
            <div class="lg:col-span-2 bg-white shadow-sm rounded-lg border border-gray-200 p-6 h-fit max-h-[calc(100vh-12rem)] overflow-y-auto" id="rightPanel" style="display: none;">
                <div id="contentDisplay">
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">ใบเสร็จรับเงิน</h2>
                        <div class="border-b pb-4 mb-4 space-y-2 text-base">
                            <div class="flex justify-between">
                                <span class="font-medium text-gray-700">ร้าน:</span>
                                <span class="text-gray-900">SSBeauty</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium text-gray-700">วันที่:</span>
                                <span class="text-gray-900">20/08/2026</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium text-gray-700">เวลา:</span>
                                <span class="text-gray-900">09:00 น.</span>
                            </div>
                        </div>
                        
                                <table class="w-full text-left mb-6 text-base">
                                    <thead class="border-b-2 border-gray-300">
                                        <tr>
                                            <th class="py-3 font-semibold text-gray-900">รายการ</th>
                                            <th class="py-3 text-right font-semibold text-gray-900">ราคา (บาท)</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200" id="receiptItems">
                                        <!-- Service and extras will be injected by JS -->
                                    </tbody>
                                </table>
                        
                        <div class="text-center mt-6">
                            <p class="text-base text-gray-600">ขอบคุณที่ใช้บริการ</p>
                        </div>

                        <div class="flex gap-3 pt-6 mt-6 border-t">
                            <button onclick="closeReceipt()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2.5 rounded-lg font-medium transition-colors text-base">
                                ปิด
                            </button>
                            <button class="flex-1 bg-[#A5848F] hover:bg-[#8a6f77] text-white px-6 py-2.5 rounded-lg font-medium transition-colors shadow-sm text-base">
                                พิมพ์ใบเสร็จ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

<script>
    const rightPanel = document.getElementById('rightPanel');
    const appointmentsData = <%- JSON.stringify(appointments || []) %>;

    function openReceipt(index) {
        const appointment = appointmentsData[index];
        
        // Update receipt content
        // build items rows (service + extras)
        let itemsRows = '';
        const serviceName = appointment.Service ? appointment.Service.name : appointment.service || '';
        const servicePrice = Number(appointment.Service ? appointment.Service.price : appointment.price) || 0;
        itemsRows += `<tr><td class="py-3 text-gray-700">${serviceName}</td><td class="py-3 text-right text-gray-900">${servicePrice}</td></tr>`;
        if (appointment.extrasArr && appointment.extrasArr.length > 0) {
            appointment.extrasArr.forEach(ex => {
                const exName = ex.name || ex.label || 'บริการเสริม';
                const exCost = Number(ex.cost || ex.price || 0) || 0;
                itemsRows += `<tr><td class="py-3 text-gray-700">+ ${exName}</td><td class="py-3 text-right text-gray-900">${exCost}</td></tr>`;
            });
        }
        const totalAmount = Number(appointment.totalAmount || servicePrice) || servicePrice;

        const receiptHTML = `
            <div class="max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">ใบเสร็จรับเงิน</h2>
                <div class="border-b pb-4 mb-4 space-y-2 text-base">
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-700">ร้าน:</span>
                        <span class="text-gray-900">SSBeauty</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-700">วันที่:</span>
                        <span class="text-gray-900">${appointment.date}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-700">เวลา:</span>
                        <span class="text-gray-900">${appointment.time} น.</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-700">ลูกค้า:</span>
                        <span class="text-gray-900">${appointment.customer}</span>
                    </div>
                </div>
                
                <table class="w-full text-left mb-6 text-base">
                    <thead class="border-b-2 border-gray-300">
                        <tr>
                            <th class="py-3 font-semibold text-gray-900">รายการ</th>
                            <th class="py-3 text-right font-semibold text-gray-900">ราคา (บาท)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${itemsRows}
                        <tr class="font-semibold border-t-2 border-gray-300">
                            <td class="py-3 text-gray-900">รวมทั้งหมด</td>
                            <td class="py-3 text-right text-[#A5848F] text-lg">${totalAmount}</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="text-center mt-6">
                    <p class="text-base text-gray-600">ขอบคุณที่ใช้บริการ</p>
                </div>

                <div class="flex gap-3 pt-6 mt-6 border-t">
                    <button onclick="closeReceipt()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2.5 rounded-lg font-medium transition-colors text-base">
                        ปิด
                    </button>
                    <button onclick="confirmPayment('${appointment.appointmentId}')" class="flex-1 bg-[#A5848F] hover:bg-[#8a6f77] text-white px-6 py-2.5 rounded-lg font-medium transition-colors shadow-sm text-base">
                        ยืนยันการชำระเงิน
                    </button>
                </div>
            </div>
        `;
        
        document.getElementById('contentDisplay').innerHTML = receiptHTML;
        rightPanel.style.display = 'block';
    }

    function closeReceipt() {
        rightPanel.style.display = 'none';
    }

    function confirmPayment(appointmentId) {
        if (confirm('ยืนยันการชำระเงินสำหรับการนัดหมายนี้?')) {
            // Create form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin/manage-payment/${appointmentId}`;
            
            // Add hidden input for status
            const statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'status';
            statusInput.value = 'completed';
            form.appendChild(statusInput);
            
            document.body.appendChild(form);
            form.submit();
        }
    }

    // Minimal refresh handler for header button
    const _refreshBtn = document.getElementById('refreshBtn');
    if (_refreshBtn) _refreshBtn.addEventListener('click', () => window.location.reload());
</script>
</body>
</html>